# SNSèªè¨¼æŠ•ç¥¨ã‚·ã‚¹ãƒ†ãƒ  ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“… **ä½œæ¥­æœŸé–“**: 2025å¹´1æœˆ18æ—¥
## ğŸ‘¤ **æ‹…å½“**: AI Assistant  
## ğŸ¯ **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: Quadratic Voting Tool - æœ¬ç•ªç’°å¢ƒå•é¡Œè§£æ±º

---

## ğŸ” **å•é¡Œã®é€²åŒ–ã¨ç¾åœ¨ã®çŠ¶æ³**

### **Phase 1: åˆæœŸå•é¡Œ (è§£æ±ºæ¸ˆã¿)**
- **ç—‡çŠ¶**: 401 Unauthorized ã‚¨ãƒ©ãƒ¼
- **åŸå› **: NextAuth.js Cookieè¨­å®š + SWR credentialsè¨­å®š
- **è§£æ±º**: Cookieè¨­å®šã¨API credentialsè¨­å®šã‚’ä¿®æ­£

### **Phase 2: ç¾åœ¨ã®å•é¡Œ**
- **ç—‡çŠ¶**: 500 Internal Server Error
- **åŸå› **: Prisma â†’ Supabaseæ¥ç¶šã®ç‰¹å®šã‚¯ã‚¨ãƒªã§ã®å¤±æ•—
- **çŠ¶æ³**: èªè¨¼ã¯æˆåŠŸã€åŸºæœ¬çš„ãªDBæ¥ç¶šã¯æ­£å¸¸

---

## ğŸ§ª **å®Ÿæ–½ã—ãŸè¨ºæ–­ãƒ†ã‚¹ãƒˆ**

### **âœ… æˆåŠŸã—ãŸãƒ†ã‚¹ãƒˆ**
1. **èªè¨¼çŠ¶æ…‹**: `Session: authenticated, Social: true`
2. **åŸºæœ¬DBæ¥ç¶š**: `/api/test-db` â†’ æ­£å¸¸å‹•ä½œ
3. **ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ**: å®Œå…¨æ­£å¸¸å‹•ä½œ
4. **æœ¬ç•ªç’°å¢ƒ**: ç°¡å˜ãªã‚¯ã‚¨ãƒª (`SELECT 1`) â†’ æˆåŠŸ

### **âŒ å¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆ**
1. **å®Ÿéš›ã®æŠ•ç¥¨API**: `/api/events/find` â†’ 500ã‚¨ãƒ©ãƒ¼
2. **ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°API**: `/api/events/details` â†’ 500ã‚¨ãƒ©ãƒ¼  
3. **Prisma findUnique**: å®Ÿéš›ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã§å¤±æ•—

---

## ğŸ” **æŠ€è¡“çš„åˆ†æ**

### **ã‚¨ãƒ©ãƒ¼ã®è©³ç´°**
```
PrismaClientInitializationError: 
Invalid `prisma.events.findUnique()` invocation:
Can't reach database server at `aws-0-ap-northeast-1.pooler.supabase.com:5432`
```

### **é‡è¦ãªç™ºè¦‹**
1. **èªè¨¼å‡¦ç†**: éƒ¨åˆ†çš„ã«æˆåŠŸ (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯ authenticated)
2. **Cookieé€ä¿¡**: æ”¹å–„ã•ã‚Œã¦ã„ã‚‹ï¼ˆCookiesæ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ä¿®æ­£æ¸ˆã¿ï¼‰
3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: åŸºæœ¬æ¥ç¶šã¯æ­£å¸¸
4. **ç’°å¢ƒå¤‰æ•°**: è¨­å®šã«å•é¡Œãªã—

---

## ğŸ¯ **å•é¡Œã®ç¯„å›²**

### **å‹•ä½œã—ã¦ã„ã‚‹æ©Ÿèƒ½**
- âœ… NextAuth.jsèªè¨¼ãƒ•ãƒ­ãƒ¼
- âœ… åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
- âœ… ç°¡å˜ãªSQLã‚¯ã‚¨ãƒªå®Ÿè¡Œ
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®å…¨æ©Ÿèƒ½

### **å•é¡ŒãŒã‚ã‚‹æ©Ÿèƒ½**
- âŒ æœ¬ç•ªç’°å¢ƒã§ã®å®Ÿéš›ã®Prismaã‚¯ã‚¨ãƒª
- âŒ `events.findUnique()` å®Ÿè¡Œ
- âŒ æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»ä¿å­˜
- âŒ ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã®å–å¾—

---

## ğŸ”¬ **æŠ€è¡“çš„ä»®èª¬**

### **ä»®èª¬1: Prisma Connection Poolå•é¡Œ**
- **åŸå› **: æœ¬ç•ªç’°å¢ƒã§ã®Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
- **ç—‡çŠ¶**: ç‰¹å®šã®ã‚¯ã‚¨ãƒªã§ã®ã¿æ¥ç¶šå¤±æ•—
- **è§£æ±ºæ¡ˆ**: Connection Poolè¨­å®šã®èª¿æ•´

### **ä»®èª¬2: Supabase Connection Pooleråˆ¶é™**
- **åŸå› **: `pooler.supabase.com` ã®æ¥ç¶šåˆ¶é™
- **ç—‡çŠ¶**: è¤‡é›‘ã‚¯ã‚¨ãƒªã§ã®æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- **è§£æ±ºæ¡ˆ**: Direct connection ã¾ãŸã¯Poolè¨­å®šå¤‰æ›´

### **ä»®èª¬3: ç’°å¢ƒä¾å­˜ã®Prismaè¨­å®š**
- **åŸå› **: æœ¬ç•ªç’°å¢ƒã§ã®Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
- **ç—‡çŠ¶**: ãƒ­ãƒ¼ã‚«ãƒ«ã¯æ­£å¸¸ã€æœ¬ç•ªã®ã¿å¤±æ•—
- **è§£æ±ºæ¡ˆ**: Prismaè¨­å®šã®æœ¬ç•ªç’°å¢ƒæœ€é©åŒ–

---

## ğŸ› ï¸ **ææ¡ˆã™ã‚‹è§£æ±ºç­–**

### **Priority 1: Connection Poolè¨­å®š**
```javascript
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

// ã¾ãŸã¯ db/index.js
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL
    }
  }
})
```

### **Priority 2: Supabase Direct Connection**
```env
# DATABASE_URLã‚’å¤‰æ›´
postgresql://[user]:[password]@db.[ref].supabase.co:5432/postgres
# pooler.supabase.com â†’ db.supabase.co
```

### **Priority 3: Prisma Clientè¨­å®š**
```javascript
// db/index.js
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
})
```

---

## ğŸ§ª **æ¬¡ã®ãƒ†ã‚¹ãƒˆè¨ˆç”»**

### **Step 1: Prismaè©³ç´°ãƒ­ã‚°ã®æœ‰åŠ¹åŒ–**
- Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã®ã‚¯ã‚¨ãƒªãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
- å®Ÿéš›ã®SQLå®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª

### **Step 2: Connection Poolè¨­å®šã®å¤‰æ›´**
- Supabaseã®ç›´æ¥æ¥ç¶šã‚’è©¦è¡Œ
- Poolerè¨­å®šã‚’èª¿æ•´

### **Step 3: æ®µéšçš„ã‚¯ã‚¨ãƒªãƒ†ã‚¹ãƒˆ**
- ç°¡å˜ãªã‚¯ã‚¨ãƒªã‹ã‚‰è¤‡é›‘ãªã‚¯ã‚¨ãƒªã¾ã§æ®µéšçš„ã«ãƒ†ã‚¹ãƒˆ
- å¤±æ•—ã™ã‚‹å¢ƒç•Œã‚’ç‰¹å®š

---

## ğŸ“Š **è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼**

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ãƒ­ãƒ¼ã‚«ãƒ« | æœ¬ç•ª(åŸºæœ¬) | æœ¬ç•ª(å®Ÿéš›) | çŠ¶æ…‹ |
|----------------|----------|------------|------------|------|
| èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  | âœ… | âœ… | âœ… | è§£æ±ºæ¸ˆã¿ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š | âœ… | âœ… | âŒ | éƒ¨åˆ†çš„å•é¡Œ |
| ç°¡å˜ãªã‚¯ã‚¨ãƒª | âœ… | âœ… | âœ… | æ­£å¸¸ |
| å®Ÿéš›ã®ã‚¯ã‚¨ãƒª | âœ… | âŒ | âŒ | è¦ä¿®æ­£ |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | âœ… | âœ… | âœ… | æ­£å¸¸ |

---

## ğŸ”§ **å³åº§ã«å®Ÿè¡Œå¯èƒ½ãªå¯¾ç­–**

### **1. DATABASE_URLã®ç¢ºèªãƒ»å¤‰æ›´**
```bash
# ç¾åœ¨ï¼ˆPoolerä½¿ç”¨ï¼‰
postgresql://[user]:[password]@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres

# å¤‰æ›´æ¡ˆï¼ˆDirectæ¥ç¶šï¼‰
postgresql://[user]:[password]@db.[ref].supabase.co:5432/postgres
```

### **2. Prismaè©³ç´°ãƒ­ã‚°ã®æœ‰åŠ¹åŒ–**
```javascript
// db/index.js
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
})
```

### **3. Connection timeoutè¨­å®š**
```javascript
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}
```

---

## ğŸ¯ **æˆåŠŸã®åˆ¤å®šåŸºæº–**

### **å®Œå…¨è§£æ±ºã®æ¡ä»¶**
1. **æŠ•ç¥¨URL**: `https://quadratic-voting-beryl.vercel.app/vote?event=ID` â†’ æ­£å¸¸è¡¨ç¤º
2. **APIå¿œç­”**: `/api/events/find` â†’ 200 OK
3. **ãƒ‡ãƒ¼ã‚¿å–å¾—**: æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®æ­£å¸¸ãªå–å¾—ãƒ»è¡¨ç¤º
4. **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**: Prismaé–¢é€£ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆ

### **éƒ¨åˆ†è§£æ±ºã®æ¡ä»¶**
1. **APIå¿œç­”**: 500ã‚¨ãƒ©ãƒ¼ â†’ 400ã‚¨ãƒ©ãƒ¼ (ã‚ˆã‚Šå…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼)
2. **ãƒ­ã‚°å‡ºåŠ›**: è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ã®ç‰¹å®š
3. **æ¥ç¶šçŠ¶æ³**: Connection poolã®çŠ¶æ…‹ç¢ºèª

---

## ğŸ“ **æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ **

1. **DATABASE_URLå¤‰æ›´**: Pooler â†’ Directæ¥ç¶š
2. **Prismaãƒ­ã‚°æœ‰åŠ¹åŒ–**: è©³ç´°ãªã‚¯ã‚¨ãƒªãƒ­ã‚°ã‚’ç¢ºèª
3. **æ®µéšçš„ãƒ†ã‚¹ãƒˆ**: ç°¡å˜ãªã‚¯ã‚¨ãƒªã‹ã‚‰å®Ÿéš›ã®ã‚¯ã‚¨ãƒªã¾ã§
4. **Supabaseè¨­å®šç¢ºèª**: Connection poolè¨­å®šã®ç¢ºèª

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ18æ—¥ 12:30 JST  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æ ¹æœ¬åŸå› ç‰¹å®šãƒ»è§£æ±ºç­–å®Ÿè¡Œæ®µéš ğŸ”§  
**å„ªå…ˆåº¦**: Critical - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå•é¡Œã®è§£æ±ºãŒå¿…è¦ 